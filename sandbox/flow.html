<html>

<head>
    <script src="./lodash.min-4.17.21.js"></script>
    <script type="text/javascript">
        console.log('Lodash version:', _.VERSION);
        // Lodash의 _.flow 함수 예제
        console.log(_.flow(
            x => x + 1,
            x => x * 2,
            x => x - 3
        )(5)); // 9

        _.flow(
            x => x + 10,
            x => x * 20,
            x => x - 30,
            console.log
        )(5); // 9

        // 다중 인자를 배열로 받는 예제
        _.flow(
            arr => _.filter(arr, n => n % 2 === 0),
            arr => _.map(arr, n => n * n),
            arr => _.take(arr, 5),
            console.log
        )(_.range(1, 101)); // [4, 16, 36, 64, 100]

        // _.flow를 통한 조합
        const products = [
            { id: 1, name: 'Laptop', price: 1000, discounted_price: 900 },
            { id: 2, name: 'Phone', price: 500, discounted_price: 450 },
            { id: 3, name: 'Tablet', price: 300, discounted_price: 300 },
            { id: 4, name: 'Monitor', price: 200, discounted_price: 180 },
            { id: 5, name: 'Keyboard', price: 100, discounted_price: 90 },
        ];

        // 10% 이상 할인된 제품 필터링
        _.flow(
            products => _.filter(products, p => (p.price - p.discounted_price) / p.price >= 0.1),
            products => _.map(products, p => ({ id: p.id, name: p.name, discount: p.price - p.discounted_price })),
            products => _.sortBy(products, 'discount').reverse(),
            // _.map(products => `${products.name}: $${products.discount}`),
            console.table
        )(products);

        // 할인 상품 중 가격이 가장 낮은 상품의 이름 찾기
        _.flow(
            // products => _.filter(products, p => (p.price - p.discounted_price) / p.price >= 0.1),
            products => _.filter(products, p => p.price > p.discounted_price),
            products => _.minBy(products, 'discounted_price'),
            product => product ? product.name : null,
            console.log
        )(products);

        // 할인이 없는 상품 중 가격이 가장 낮은 상품의 name 찾기
        _.flow(
            products => _.filter(products, p => p.price === p.discounted_price),
            products => _.minBy(products, 'price'),
            // product => _.property('id')(product),
            product => product.name || null,
            console.log
        )(products);

        // 총 할인 금액 계산
        _.flow(
            products => _.map(products, p => p.price - p.discounted_price),
            discounts => _.sum(discounts),
            console.log
        )(products); // 180

        // ############## 비동기 처리 예제
        const asyncAdd = (x, y) => new Promise(resolve => {
            // 10초 대기
            setTimeout(() => resolve(x + y), 2000);
        });

        // 비동기 파이프라인 구현 (Promise 체이닝을 이용)
        const asyncFlow = (funs) => (initialValue) => {
            return _.reduce(funs, (promise, fn) => {
                // 이전 Promise가 해결된 후, 다음 함수를 실행하는 새로운 Promise를 반환
                return promise.then(fn);
            }, Promise.resolve(initialValue));
        };

        // --- 실행 ---
        console.log('Starting async flow...');

        asyncFlow([
            // 첫 번째 함수는 초기값을 받음 (initialValue: 0)
            (initial) => asyncAdd(initial + 5, 10),

            // 다음 함수는 앞 Promise의 결과값 (sum: 15)을 받음
            sum => asyncAdd(sum, 20),

            // 최종 결과값 (total: 35)을 받음
            total => console.log('Total after async additions:', total)
        ])(0); // 초기값 0으로 시작

        // 출력:
        // Starting async flow... (즉시)
        // ... 2 후 ...
        // Total after async additions: 35

    </script>
</head>

<body></body>

</html>